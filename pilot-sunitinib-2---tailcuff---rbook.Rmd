---
title: "Piloting the administration of Sunitinib via oral gavage and measuring blood pressure by the tail-cuff method"
output:
  html_document:
    df_print: paged
---

## Procedural outline
Turn on machines / heaters. Put mice in tailcuff room and let the room and mice acclimate to appropriate temperature for ~30-60 mins. Then, check cuffs for leaks. Put mice into restraints and perform 5 acclimation cycles + 20 recorded cycles. 

When placing mice into restraints,  
  1. Quickly place nose cuff on to avoid letting them turn around in the restraint\
  2. Make sure that you can see them breathing...  
  3. Maximize tightness of fit and breathing

```{r read_data,  echo = FALSE, message=FALSE, warning=FALSE}
library(tidyverse)

library(ggthemes)
library(ggforce)
# library(ggstatsplot)
# library(gapminder)
library(ggsci)
library(ggpubr)
library(rstatix) # identify_outliers

library(readxl)
library(forcats)

library(knitr)
library(kableExtra)

library(gridExtra)
library(GetoptLong)

library(randomizr)

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, results = "asis", fig.width = 10, fig.height = 8)

my_theme <- theme_stata() + 
  theme(plot.title = element_text(face = "bold", size = 20),
        plot.subtitle = element_text(face = "italic", color = "black"),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 14, face = "bold")) 
        
        

#' reads in mega excel file 
fn_name <- "Pilot 2 - Sunitinib oral gavage - MASTER.xlsx"
data_temp <- read_excel(qq("/Users/Nicholas/OneDrive - Tufts/phd/projects/vegfri/sunitinib/mouse-studies/data/tail-cuff/@{fn_name}"), 
                   sheet = 1) %>% 
  select(`Specimen Name`, Systolic, Mean, Rate, `Cycle #`, `Date`, Phase) %>%
  mutate(Date = as.Date(Date, "GMT")) %>%
  arrange(Date, `Specimen Name`, `Cycle #`) %>%
  mutate(`Specimen Name` = factor(`Specimen Name`, levels = str_c("M", seq(1, 10, 1)))) %>%
  filter(Phase != "training") %>%
  mutate(Phase = factor(Phase, levels = c("baseline", "vehicle", "treatment"))) %>%
  arrange(Phase, `Specimen Name`)


meta_df_all <- read_excel(qq("/Users/Nicholas/OneDrive - Tufts/phd/projects/vegfri/sunitinib/mouse-studies/@{fn_name}"),
                   sheet = 2) %>%
  mutate(Date = as.Date(Date, "GMT"),
         DOB = as.Date(DOB, "GMT")) %>%
  arrange(Date, `Specimen Name`) %>%
  mutate(`Specimen Name` = factor(`Specimen Name`, levels = str_c("M", seq(1, 10, 1))),
         `Date` = as.factor(Date),
         `Date of death` = as.factor(as.Date(`Date of death`))) %>%
  group_by(`Specimen Name`)

meta_df_temp <- meta_df_all %>% 
  filter(tolower(Status) != "dead") %>% # filter out mice that have died
  summarize(`Average body weight (g)` = mean(`Body weight (g)`), .groups = "keep")
meta_df <- inner_join(meta_df_all %>% select(-`Body weight (g)`, -`Date`) %>% distinct(), 
                                     meta_df_temp) %>%
  arrange(`Specimen Name`)

# block random assignment by machine

set.seed(3334)
num_mice <- nrow(meta_df);
# https://cran.r-project.org/web/packages/randomizr/vignettes/randomizr_vignette.html
meta_df_w_assign <- meta_df %>% 
  bind_cols(tibble(group = complete_ra(N = num_mice, prob = 0.625))) %>%
  mutate(group = ifelse(group == 0, "vehicle", "sunitinib")) %>%
  mutate(group = factor(group, levels = c("sunitinib", "vehicle"))) %>%
  arrange(`Specimen Name`, group) %>%
  select(group, everything())

num_mice_per_group <- meta_df_w_assign %>% 
  group_by(group) %>%
  summarize(n = n())

# merge data and meta
data <- data_temp %>% 
  inner_join(meta_df_w_assign) %>%
  mutate(color = ifelse(group == "vehicle", "#1e81b0", "#ed9942")) %>%
  mutate(color = factor(color, levels = c("#ed9942", "#1e81b0")))

sun_color <- which(meta_df_w_assign$group == "sunitinib")
veh_color <- which(meta_df_w_assign$group == "vehicle")
```

## Download excel data after finishing the experiments onto thumb drive
Copy the data into a *master* excel file with two sheets, making sure that there's only one header (at the very top of the page).    

  1. You'll need to add in two columns manually to this master sheet: *Date* and *Phase*. Phase can take one of 4 values: "training", "baseline", "vehicle", "treatment". Training data ultimately gets removed, but included in the data sheet for completeness. First sheet should look like this:  
```{r data_shape, echo = FALSE, message=FALSE, warning=FALSE}

header_to_edit <- colnames(data_temp)[6]
kable(head(data_temp, n = 6), caption = "Metadata", align = "c") %>%
  column_spec(column = c(ncol(data_temp)-1, ncol(data_temp)), background = "green") %>%
  kable_styling("striped") 

```
  2. Second sheet should be created manually based on your mice. Fill in the various fields. 
```{r data_shape2, echo = FALSE, message=FALSE, warning=FALSE}
kable(head(meta_df_all %>% arrange(`Specimen Name`), n = 8), caption = "Metadata", align = "c") %>%
  kable_styling("striped")
```

## Metadata Analysis
This workbook is set up to analyze two groups of mice! Just run and enjoy (you'll probably need to change out drug names...)

```{r plot_meta, echo = FALSE, message=FALSE, warning=FALSE}
kable(meta_df_w_assign, caption = "Metadata", align = "c") %>%
  kable_styling("striped") %>%
  row_spec(sun_color, bold = T, color = "white", background = "#ed9942") %>%
  row_spec(veh_color, bold = T, color = "white", background = "#1e81b0")


# table(tx = meta_df_w_assign$group, machine = meta_df_w_assign$`Machine ID`

```


## Inspect accepted cycles and changes in mouse body weight over time
```{r accepted_cycles, echo = FALSE, message=FALSE, warning=FALSE, fig.height=8}
remove_bad_days_df1 <- data %>%
  group_by(`Specimen Name`, Date, group, color) %>%
  summarize(n = n()) %>%
  arrange(Date, `Specimen Name`) 

g1 <- ggplot(remove_bad_days_df1, aes(fill = `group`, x = Date, y = n)) +
  geom_bar(position = "dodge", stat = "identity") +
  scale_fill_manual(name = "group", values = levels(remove_bad_days_df1$color)) +
  my_theme +
  scale_y_continuous(breaks=seq(0,35,5)) +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  ylab("Number of Accepted Cycles") +
  ggtitle("Accepted cycles per mouse over time") + 
  facet_grid(cols = vars(`Specimen Name`))
g1

```
### Average animal body weight
```{r avg_bodyweight, fig.height=8, fig.width=8}
g2 <- ggplot(meta_df_w_assign, aes(fill = `group`, x = `Specimen Name`, y = `Average body weight (g)`)) +
  geom_bar(position = "dodge", stat = "identity") +
  scale_fill_manual(name = "group", values = levels(remove_bad_days_df1$color)) +
  my_theme +
  scale_y_continuous(breaks=seq(0,30,5)) +
  ylab("Body weight (g)") +
  ggtitle("Average animal body weight (g)") + 
  geom_text(
    aes(x = `Specimen Name`, y = `Average body weight (g)`, label = round(`Average body weight (g)`,1), vjust = 2.5), 
    hjust = 0.5, color = "white", size = 5, 
    inherit.aes = TRUE) 
g2

dates <- unique(meta_df_all$Date)
reps <- length(unique(meta_df_all$`Specimen Name`))
date_tbl <- tibble(Date = rep(dates, reps))
```

### Animal body weight change over time
```{r weight_change, fig.height=8, fig.width = 12}       
weight_change_df <- meta_df_all %>%
  group_by(`Specimen Name`) %>% 
  summarize(`Weight change (g)` = c(0, diff(`Body weight (g)`))) %>%
  bind_cols(date_tbl) %>%
  mutate(Date = as.Date(Date)) %>%
  left_join(data %>% distinct(`Specimen Name`, group))

ggplot(weight_change_df %>% na.omit(), aes(x = `Date`, y = `Weight change (g)`, color = `group`)) +
  geom_point(show.legend = F) + 
  geom_line() + 
  scale_color_manual(name = "group", values = levels(remove_bad_days_df1$color)) + 
  my_theme +
  scale_fill_manual(name = "Weight change (g)", ) + 
  scale_y_continuous(breaks = seq(-10,10,.2)) +
  scale_x_date(breaks = unique(weight_change_df$Date)) +
  theme(axis.text.x = element_text(angle = 75, size = 8, vjust = 0.5),
        axis.text.y = element_text(hjust = 0.55),
        panel.spacing = unit(2, "lines")) +
    labs(title = "Weight change (g) since beginning of experiment\n") +
  facet_grid(cols = vars(`Specimen Name`))
```

```{r change_weight_avg}
# daily average weight loss


daily_lost_weight_avg_df <- weight_change_df %>% 
  na.omit() %>% 
  group_by(Date) %>%
  summarize(weight_loss_avg = mean(`Weight change (g)`))

final_avg_weight <- daily_lost_weight_avg_df %>% slice(n()) 
  
ggplot(daily_lost_weight_avg_df, aes(x = `Date`, y = `weight_loss_avg`)) +
  geom_point(show.legend = F) + 
  geom_line() + 
  geom_smooth(method = "lm") +
  my_theme +
  geom_label(data = final_avg_weight, label = final_avg_weight$weight_loss_avg, vjust = 1.5, color = "red") +
  ylab("Average daily weight change (g)") + 
  scale_y_continuous(breaks = seq(-10,10,.2)) +
  scale_x_date(breaks = unique(weight_change_df$Date)) +
  theme(axis.text.x = element_text(angle = 75, size = 8, vjust = 0.5),
        axis.text.y = element_text(hjust = 0.55),
        panel.spacing = unit(2, "lines")) +
    labs(title = "Average weight change (g) across all mice\nsince beginning of experiment\n")  
```

## Blood Pressure Data Analysis
### Filtering out days that had less than 'x' cycles
```{r bad_days1, echo = FALSE, message=FALSE, warning=FALSE}
FILTER_OUT_LESS_THAN_CYCLES <- 5
removed_df_temp <- inner_join(remove_bad_days_df1 %>% filter(n < FILTER_OUT_LESS_THAN_CYCLES), 
                         remove_bad_days_df1) %>%
  mutate(reason = "Low cycle count")

other_df <- remove_bad_days_df1 %>% # bladder exploded on this day
  filter((Date == "2021-03-12" && `Specimen Name` == "M1")) %>%
  mutate(reason = "Bladder explosion")
removed_df <- bind_rows(removed_df_temp, other_df) %>% arrange(Date)

# print("Removed days/Specimens:")
kable(removed_df %>% rename(`# cycles` = n) %>% select(-color), 
      caption = qq("Removed days/Specimens with less than @{FILTER_OUT_LESS_THAN_CYCLES} cycles:")) %>%
  kable_styling("striped")

# filtered df
bad_days_removed_df <- anti_join(data, removed_df) 

```

### Removing outliers
Detect outliers using boxplot methods. Boxplots are a popular and an easy method for identifying outliers. There are two categories of outlier: (1) outliers and (2) extreme points. Values above Q3 + 1.5xIQR or below Q1 - 1.5xIQR are considered as outliers. Values above Q3 + 3xIQR or below Q1 - 3xIQR are considered as extreme points (or extreme outliers). Q1 and Q3 are the first and third quartile, respectively. IQR is the interquartile range (IQR = Q3 - Q1).

Alternative method: If the absolute difference (i.e. abnormally high or low) between a measurement and the mean of all the cycles for that day is greater than twice the standard deviation for that day, that measurement is removed. It's assumed that this measurement is due to animal movement or some other non-biological cause.



```{r outliers, echo = FALSE, message=FALSE, warning=FALSE}
mark_outliers_df <- bad_days_removed_df %>%
  group_by(`Specimen Name`, `Date`) %>%
  identify_outliers("Systolic")

# remove all rows that are outliers
# set factor 
final_filtered_data <- anti_join(bad_days_removed_df, mark_outliers_df ) %>%
  group_by(`Specimen Name`, `Date`, Phase, color, group) %>%
  mutate(Phase = factor(Phase, levels = c("training", "baseline", "vehicle", "treatment"))) %>%
  arrange(Phase)

```




## Plot the data over time and visualize the variance per day, per sample with boxplots, over all days
### Starting 03/05/21 - oral gavage and tailcuff training begins
### Starting 03/08/21 - baseline recording before vehicle treatment
### Starting 03/11/21 - vehicle treatment (10% PEG/ 0.5% Tween /~90% DI H2O at pH ~3.5) begins to establish baseline BP
### Starting 03/15/21 - Randomized to Sunitinib (40 mg/kg/d) treatment or vehicle begins

Since blood pressure is always measured before oral gavage, baseline goes from 03/08 to 03/11, but vehicle treatment starts on 03/11. Observed effect of treatment is then on 03/12!!

```{r calc_important_dfs, echo = FALSE, message=FALSE, warning=FALSE}

#' @Note main df! this is specimen average
specimen_avg_data_df <- final_filtered_data %>% 
  summarize(`specimen_mean_systolic` = mean(Systolic), 
            `specimen_median_systolic` = median(Systolic),
            specimen_sd_systolic = sd(Systolic),
            specimen_sem = specimen_sd_systolic / sqrt(num_mice), 
            .groups = "keep") %>%
  ungroup() %>%
  mutate(Phase = factor(Phase, levels = c("baseline", "vehicle", "treatment")))

group_wise_bp_and_sem <- specimen_avg_data_df %>%
  group_by(`Specimen Name`, group, Phase) %>% 
  summarize(specimen_grp_phase_mean_systolic = mean(specimen_mean_systolic),
            specimen_grp_phase_sd_systolic = sd(specimen_mean_systolic),
            specimen_grp_phase_sem = specimen_grp_phase_sd_systolic / sqrt(num_mice)) 

phase_wise_bp_and_sem <- specimen_avg_data_df %>%
  group_by(group, Phase) %>% 
  summarize(grp_phase_mean_systolic = mean(specimen_mean_systolic),
            grp_phase_sd_systolic = sd(specimen_mean_systolic),
            grp_phase_sem = grp_phase_sd_systolic / sqrt(num_mice)) 

```

### Assess BP of randomized groups before beginning treatment
```{r before_rand_summary}
ggplot(data = phase_wise_bp_and_sem %>% filter(Phase != "treatment"), 
       aes(fill = `group`, x = group, y = grp_phase_mean_systolic)) +
  
  geom_bar(position = "dodge", stat = "identity", width = 0.5) +
    # error bar over whole phase
  geom_errorbar(aes(ymin = grp_phase_mean_systolic - grp_phase_sem,
                    ymax = grp_phase_mean_systolic + grp_phase_sem), width=.2,
                position = position_dodge(0.05)) +
  # individual group points per phase
  geom_point(group_wise_bp_and_sem %>% filter(Phase != "treatment"), 
             mapping = aes(x = group, y = specimen_grp_phase_mean_systolic), show.legend = F) + 
  
  # text by group and phase
  geom_text(data = phase_wise_bp_and_sem %>% filter(Phase != "treatment"), 
            aes(x = `group`, y = grp_phase_mean_systolic, 
                label = round(grp_phase_mean_systolic,1), vjust = 2.5), 
    hjust = 0.5, color = "white", size = 5, 
    inherit.aes = FALSE) + 
  
  # change fill colors
  scale_fill_manual(name = "group", values = levels(specimen_avg_data_df$color)) +
  my_theme +
  
  scale_y_continuous(breaks=seq(0, 150, 25)) +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  ylab("Average Systolic BP") +
  labs(caption = "Unfiltered data") +
  ggtitle("Average Systolic BP across phases\n*before* randomization") +
  facet_grid(col = vars(Phase)) + 
  stat_compare_means(data = phase_wise_bp_and_sem %>% filter(Phase != "treatment"), 
                     aes(group = group), label = "p.format", method = "anova") +
  labs(caption = "Statistical testing: ANOVA")

# avg_bp_before_rand_g
```


```{r plot_groupwise}



ggplot(data = phase_wise_bp_and_sem, 
       aes(fill = `group`, x = group, y = grp_phase_mean_systolic)) +
  
  geom_bar(position = "dodge", stat = "identity", width = 0.5) +
  # stat_summary(fun ="mean", color = "cyan", show.legend = F) +
  
  geom_point(group_wise_bp_and_sem, 
             mapping = aes(x = group, y = specimen_grp_phase_mean_systolic), 
             show.legend = FALSE, inherit.aes = FALSE) + 
  
  # text by group and phase
  geom_label(data = phase_wise_bp_and_sem,
            aes(x = `group`, y = max(grp_phase_mean_systolic) + 35,
                label = round(grp_phase_mean_systolic,1)),
    hjust = 0.5, color = "black", size = 3,
    inherit.aes = FALSE, show.legend = F) +

  geom_errorbar(data = phase_wise_bp_and_sem,
                aes(x = group, ymin=`grp_phase_mean_systolic`-grp_phase_sem, 
                    ymax=`grp_phase_mean_systolic`+grp_phase_sem), width=.2,
                position=position_dodge(0.05), show.legend = F, inherit.aes = FALSE) +
  # change fill colors
  scale_fill_manual(name = "group", values = levels(specimen_avg_data_df$color)) +
  my_theme +
  
  scale_y_continuous(breaks=seq(40, 175, 10)) +
  theme(axis.text.x = element_text(angle = 60, hjust=1),
        axis.text.y = element_text(hjust = 0.5)) +
  ylab("Average Systolic BP") +
  ggtitle("Average Systolic BP across phases") +
  facet_grid(cols = vars(Phase), scale = "free_x") 

```

```{r avg_group_diff_dfs}

# specimen_avg_data_df specimen_mean_systolic
# group_wise_bp_and_sem specimen_grp_phase_mean_systolic
# phase_wise_bp_and_sem grp_phase_mean_systolic


diff_by_group <- phase_wise_bp_and_sem %>% 
  group_by(group) %>%
  # ordered by Phase factor! so baseline compared to vehicle compared to treatment
  mutate(phase_grp_avg_diff = c(0, diff(grp_phase_mean_systolic)),
         phase_grp_sd_diff = c(0, diff(grp_phase_sd_systolic)),
         phase_grp_sem_diff = c(0, diff(grp_phase_sem)))

# 24 rows
diff_by_group_per_specimen <- group_wise_bp_and_sem %>%
  group_by(group, `Specimen Name`) %>%
  mutate(specimen_phase_grp_avg_diff = c(0, diff(specimen_grp_phase_mean_systolic)),
         specimen_phase_grp_sd_diff = c(0, diff(specimen_grp_phase_sd_systolic)),
         specimen_phase_grp_sem_diff = c(0, diff(specimen_grp_phase_sem))) 
```


### Plotting average difference between groups across phases
Differences are calculated as change per specimen over each phase
```{r plot_avg_diff}

ggplot(diff_by_group, 
       aes(fill = `group`, x = group, y = `phase_grp_avg_diff`)) +
  geom_bar(position = "dodge", stat = "identity", width = 0.5) +
  
  geom_point(diff_by_group_per_specimen, 
             mapping = aes(x = group, y = `specimen_phase_grp_avg_diff`), show.legend = F) + 
  scale_color_identity() + 
  scale_fill_manual(name = "group", values = levels(specimen_avg_data_df$color)) +
  geom_errorbar(data = diff_by_group,
                aes(ymin=`phase_grp_avg_diff`-grp_phase_sem, 
                    ymax=`phase_grp_avg_diff`+grp_phase_sem), width=.2,
                position=position_dodge(0.05)) +
  my_theme + 
  scale_y_continuous(breaks=seq(-25, 50, 5)) +
  geom_text(data = diff_by_group, 
            aes(x = `group`, y = `phase_grp_avg_diff`, 
                label = round(`phase_grp_avg_diff`,1), vjust = 2.5), 
            hjust = 0.5, color = "black", size = 5, 
            inherit.aes = FALSE) + 
  theme(axis.text.x = element_text(angle = 60, hjust=1),
        axis.text.y = element_text(hjust = 0.5)) +
        labs(caption = "Statistical testing: ANOVA\nError bars calculated as mean +/- SEM\nDifferences calculated by subtracting vehicle from treatment phase BP per specimen across phases") +
  ylab("Average difference in\nSystolic BP (mmHg)") +
  ggtitle("Difference in Average Systolic BP \nacross phases") +
  facet_grid(col = vars(Phase)) + 
  stat_compare_means(data = diff_by_group_per_specimen, 
                     aes(x = group, y = specimen_phase_grp_avg_diff, group = group), 
                     label = "p.format", inherit.aes = F,
                     label.y = max(diff_by_group_per_specimen$specimen_phase_grp_avg_diff), method = "anova") 

```

### Compared to average baseline
```{r avg_baseine_comp}


# 1-element vector
vehicle_avg_by_phase <- diff_by_group %>% 
  ungroup() %>%
  filter(Phase == "vehicle") %>% 
  pluck("grp_phase_mean_systolic") %>% # these were randomized to treatment after vehicle phase
  # so this average is simply vehicle treated mice
  mean()

# 8 rows
vehicle_diff_df <- diff_by_group_per_specimen %>%
  ungroup() %>%
  filter(Phase == "vehicle") %>%
  group_by(group, Phase)

# 8 rows
tx_diff_df <- diff_by_group_per_specimen %>%
  ungroup() %>%
  filter(Phase == "treatment") %>%
  group_by(group, Phase)

diff_df <- bind_rows(vehicle_diff_df, tx_diff_df)


# 2 rows
tx_diff_avg_df <-  tx_diff_df %>%
  summarize(tx_phase_avg = mean(specimen_grp_phase_mean_systolic),
            sem = sd(specimen_grp_phase_mean_systolic)/num_mice) %>%
  mutate(vehicle_avg = vehicle_avg_by_phase, 
         avg_diff = tx_phase_avg - vehicle_avg)


ggplot(tx_diff_avg_df,
       aes(fill = `group`, x = group, y = `avg_diff`)) +
  geom_bar(position = "dodge", stat = "identity", width = 0.5) +
  geom_point(tx_diff_df,
             mapping = aes(x = group, y = `specimen_phase_grp_avg_diff`), show.legend = F) +
 geom_text(aes(x = `group`, y = `avg_diff`, label = round(`avg_diff`,1), vjust = 2.5),
          hjust = 0.5, color = "black", size = 5,
          inherit.aes = TRUE) +
  
  scale_fill_manual(name = "group", values = levels(data$color)) +
  geom_errorbar(aes(ymin=`avg_diff`-sem, ymax=`avg_diff`+sem), width=.2,
                 position=position_dodge(0.05)) +
  my_theme +
  scale_y_continuous(breaks=seq(-25, 50, 5)) +
  theme(axis.text.x = element_text(angle = 60, hjust=1),
        axis.text.y = element_text(hjust = 0.5)) +
        labs(caption = "Statistical testing: ANOVA\nError bars calculated as mean +/- SEM\nDifference calculated by taking average of vehicle group and\nsubtracting this value from each specimen's averaged treatment BPs") +
  ylab("Average difference in\nSystolic BP (mmHg)") +
  ggtitle("Difference in Treatment-phase averaged BP\ncompared to averaged vehicle-phase") +
  stat_compare_means(data = diff_df, 
                     aes(x = group, y = specimen_phase_grp_avg_diff, group = group), 
                     label = "p.format", inherit.aes = F,
                     label.y = max(diff_df$specimen_phase_grp_avg_diff), method = "anova") 

```



### Time-series data
For completeness, here is the time series data of each mouse across each Phase of the experiment:
```{r time, fig.width=15, fig.height=10}
#scale_fill_brewer(palette=3) has a really pretty purple hue

#' @NOTE: maybe facet by specimen AND 

plot_time_series_dates_add <- specimen_avg_data_df %>%
  group_by(Phase) %>% 
  arrange(Phase, Date) %>% # critical to sort because we use first and last next
  summarize(start = as.Date(first(Date)), end = as.Date(last(Date)) + 1) %>%  # just add 1 day!
  mutate(date_range = map2_chr(start, end, function(f,l){
    res <- str_c(c(as.character(f), as.character(l)), collapse = " to ")
    return(res)
  })) %>%
  mutate(mid_s = (start - end)/2,
         mid = end + mid_s) # basically get midpoint date

plot_time_series_df <- specimen_avg_data_df %>% 
  left_join(plot_time_series_dates_add)



ggplot(plot_time_series_df, 
       aes(x = `Date`, 
           y = specimen_mean_systolic, color = `group`, shape = `Specimen Name`)) +
  scale_shape_manual(values = c(0:4,10:12)) +
  geom_point(size = 6) +
  geom_line(show.legend = FALSE) +
  
  geom_rect(data = plot_time_series_dates_add, inherit.aes = F, 
            aes(xmin = start, xmax = end, ymin = -Inf, ymax = Inf, fill = Phase),
            alpha = 0.3, show.legend = F) +
  
  geom_label(data = plot_time_series_dates_add, 
             aes(x = mid, y = min(plot_time_series_df$specimen_mean_systolic), 
                 label = Phase), inherit.aes = FALSE, show.legend = FALSE, size = 6) + 

  geom_vline(aes(xintercept = start),
             data = plot_time_series_dates_add,
             colour = "grey50", alpha = 0.5, show.legend = FALSE) +

  geom_errorbar(aes(ymin = specimen_mean_systolic - specimen_sem, 
                    ymax = specimen_mean_systolic + specimen_sem), width=.2,
                position=position_dodge(0.05), show.legend = FALSE) +
  my_theme + 
  scale_fill_manual(values = c("gray", "#1e81b0", "#ed9942")) + 
  scale_color_manual(name = "group", values = levels(specimen_avg_data_df$color)) +
  
  scale_y_continuous(breaks=seq(70,220,10)) +
  scale_x_date(breaks=unique(specimen_avg_data_df$Date)) +
  theme(axis.text.x = element_text(angle = 60, hjust=1),
        axis.text.y = element_text(hjust = 0.5)) +
  labs(title = "Time-series plot of Average Tail-cuff Systolic BP measurements") + 
  ylab("Systolic blood pressure (mmHg)")
  # facet_grid(cols = vars(`Specimen Name`),  scales = "free_x")
```

```{r avg_time_series}
time_series_avg_by_group_phase <- specimen_avg_data_df %>%
  group_by(group, Phase, Date) %>%
  summarize(group_phase_avg_systolic = mean(specimen_mean_systolic),
            group_phase_sem = sd(specimen_mean_systolic)/sqrt(num_mice))

ggplot(time_series_avg_by_group_phase, 
       aes(x = `Date`, 
           y = group_phase_avg_systolic, color = `group`)) +
  geom_point(show.legend = F) + 
  geom_line() + 
  # scale_color_jco() + 
  my_theme + 
  geom_errorbar(aes(ymin = group_phase_avg_systolic - group_phase_sem, 
                    ymax = group_phase_avg_systolic + group_phase_sem), width=.2,
                position=position_dodge(0.05))+
  scale_y_continuous(breaks=seq(70,220,10)) +
  scale_x_date(breaks=unique(specimen_avg_data_df$Date)) +
  theme(axis.text.x = element_text(angle = 60, hjust=1),
        axis.text.y = element_text(hjust = 0.5)) +
  labs(title = "Time-series plot of Average Tail-cuff Systolic BP measurements") + 
  ylab("Systolic blood pressure (mmHg)") +
  scale_color_manual(name = "group", values = levels(specimen_avg_data_df$color)) +
  facet_grid(cols = vars(Phase),  scales = "free_x")
```

```{r time_series_diff}

# veh_base <- vehicle_diff_df %>% 
#   summarize(group_phase_avg_systolic = mean(specimen_grp_phase_mean_systolic), 
#             group_phase_sem = sd(specimen_grp_phase_mean_systolic)/sqrt(num_mice))

time_series_avg_diff <- time_series_avg_by_group_phase %>%
  mutate(time_series_avg_diff = c(0, diff(group_phase_avg_systolic)),
         time_series_sem_diff = c(0, diff(group_phase_sem))) %>%
  arrange(Phase)
  
  
ggplot(time_series_avg_diff, 
       aes(x = `Date`, 
           y = time_series_avg_diff, color = `group`)) +
  geom_point(show.legend = F) + 
  geom_line() + 
  # scale_color_jco() + 
  my_theme + 
  geom_errorbar(aes(ymin = time_series_avg_diff - time_series_sem_diff, 
                    ymax = time_series_avg_diff + time_series_sem_diff), width=.2,
                position=position_dodge(0.05))+
  scale_y_continuous(breaks=seq(-20,20,5)) +
  scale_x_date(breaks=unique(specimen_avg_data_df$Date)) +
  theme(axis.text.x = element_text(angle = 60, hjust=1),
        axis.text.y = element_text(hjust = 0.5)) +
  labs(title = "Time-series plot of Average *Difference*\nTail-cuff Systolic BP measurements") + 
  ylab("Systolic blood pressure (mmHg)") +
  scale_color_manual(name = "group", values = levels(specimen_avg_data_df$color)) +
  facet_grid(cols = vars(Phase),  scales = "free")
```


### Treatment with Sunitinib start on 03/15/21 BP (recording of effect starts on 03/16/21)
Since BP is recorded before gavage to reduce stress

These are the average blood pressures of each mice across each Phase of the experiment

```{r treatment, echo = FALSE, message=FALSE, warning=FALSE,fig.width=14}

cutoff_dates_df <- specimen_avg_data_df %>% 
  group_by(Phase) %>% 
  summarize(first = first(Date), last = last(Date)) %>% 
  mutate_all(.funs = as.character) %>% 
  mutate(date_range = map2_chr(first, last, function(f,l){
    res <- str_c(c(f, l), collapse = " to ")
    return(res)
  }))

# training_date_range <- cutoff_dates_df %>% filter(Phase == 'training') %>% pluck('date_range')
baseline_date_range <- cutoff_dates_df %>% filter(Phase == 'baseline') %>% pluck('date_range')
vehicle_date_range <- cutoff_dates_df %>% filter(Phase == 'vehicle') %>% pluck('date_range')
tx_date_range <- cutoff_dates_df %>% filter(Phase == 'treatment') %>% pluck('date_range')

ggplot(final_filtered_data, aes(x = `Specimen Name`, y = `Systolic`, group = `Specimen Name`, fill = `group`)) +
  geom_boxplot(position = "dodge", alpha=0.8) +
  stat_summary(fun.y="mean", color = "cyan", show.legend = F) + 
  scale_y_continuous(breaks=seq(70,250,10)) +
  # scale_fill_jco() + 
  scale_fill_manual(name = "group", values = levels(final_filtered_data$color)) +
  labs(title = "Boxplots of Mice Systolic BP by Tail-cuff by Phase",
     subtitle = qq("Baseline: @{baseline_date_range}\nVehicle Tx: @{vehicle_date_range}\nSunitinib Tx: @{tx_date_range}")) +
  ylab("Systolic blood pressure (mmHg)") +
  my_theme +
  geom_label(data = group_wise_bp_and_sem, 
             aes(label = round(specimen_grp_phase_mean_systolic,1), 
                 x = `Specimen Name`, hjust = 0.5, y = 200), 
            inherit.aes = FALSE) + 
  facet_grid(cols = vars(Phase))

```

